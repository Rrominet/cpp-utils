#!/usr/bin/env python3
import os
import sys
import subprocess
import shutil
import time

def run(cmd, check=True, cwd=None):
    print(f"â†’ {cmd}")
    subprocess.run(cmd, shell=True, check=check, cwd=cwd)

def main():
    # must be root
    if os.geteuid() != 0:
        print("This script must be run as root (use sudo)", file=sys.stderr)
        sys.exit(1)

    path = "/usr/local/lib/libmlapi.so"

    if os.path.isfile(path):
        mtime = os.path.getmtime(path)   # last modification time (seconds since epoch)
        age = time.time() - mtime        # file age in seconds

        if age < 1800:  # 1800 = 30min
            print("mlapi is already installed and recent (less than 30min). Skipping.")
            exit(0);
        else:
            print("mlapi is already installed but older than 30min. Reinstalling...")
            os.remove(path)
    else:
        print("mlapi is not installed. Installing...")

    # install deps
    run("apt install -y build-essential git gcc g++ wget zip unzip libboost-all-dev")

    # clone py-utils
    os.chdir("..")
    if os.path.isdir("py-utils"):
        print("py-utils directory already exists. Removing it.")
        shutil.rmtree("py-utils")
    run("git clone https://github.com/Rrominet/py-utils.git")
    os.chdir("py-utils")
    run("chmod +x ./install")
    run("./install")
    os.chdir("..")
    shutil.rmtree("py-utils")

    # cpp-utils_dependencies
    if os.path.isdir("cpp-utils_dependencies"):
        print("cpp-utils_dependencies directory already exists. Skipping the download.")
        dpdir = os.path.abspath("cpp-utils_dependencies")
    else:
        os.mkdir("cpp-utils_dependencies")
        os.chdir("cpp-utils_dependencies")
        dpdir = os.getcwd()

        urls = [
            "https://motion-live.com/fxos/dependencies/json.zip",
            "https://motion-live.com/fxos/dependencies/eigen.zip",
            "https://motion-live.com/fxos/dependencies/sha3.zip",
            "https://motion-live.com/fxos/dependencies/fmodstudioapi20000linux.zip",
            "https://motion-live.com/fxos/dependencies/FreeImage.zip",
            "https://motion-live.com/fxos/dependencies/FreeImagePlus-build.zip",
        ]

        for url in urls:
            run(f"wget {url}")
        for fname in os.listdir("."):
            if fname.endswith(".zip"):
                run(f"unzip {fname}")
                os.remove(fname)
        os.chdir("..")

    # fmod lib
    if os.path.isfile("/usr/local/lib/libfmod.so"):
        print("Fmod lib already installed. Skipping.")
    else:
        print("Installing fmod lib on the system (/usr/local/lib)...")
        src = os.path.join(dpdir, "fmodstudioapi20000linux/api/core/lib/x86_64")
        run(f"cp {src}/* /usr/local/lib/")
        print("Fmod lib installed.")

    # build cpp-utils
    os.chdir("cpp-utils")
    run("chmod +x ./make")
    os.makedirs("build", exist_ok=True)
    os.chdir("build")
    run(f"../make release libs=\"{dpdir}\"")
    run("chmod 755 ./libmlapi.so")

    libpath = "/usr/local/lib/libmlapi.so"
    if os.path.isfile(libpath):
        print("Old version of mlapi found. Removing it.")
        run(f"rm -vf {libpath}")
    run(f"cp ./libmlapi.so {libpath}")
    run("chmod +x ../add-local-to-linker")
    run("../add-local-to-linker")

    print("The shared library libmlapi.so (cpp-utils) is installed in /usr/local/lib/libmlapi.so")

if __name__ == "__main__":
    main()
